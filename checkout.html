<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParkNGo Checkout</title>
    <style>
      body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background: #f8fafc; color: #0f172a; text-align: center; }
      .btn { display: none; margin-top: 20px; padding: 12px 24px; background: #2f80ed; color: white; border-radius: 12px; text-decoration: none; font-weight: bold; }
    </style>
  </head>
  <body>
    <div id="status">Initiating Secure Payment...</div>
    <a id="fallback-btn" class="btn">Return to App Manually</a>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
      const params = new URLSearchParams(window.location.search);
      const appScheme = params.get("appScheme") || "parkngo://";
      
      const options = {
        "key": params.get("keyId"),
        "amount": params.get("amount"),
        "currency": "INR",
        "name": "ParkNGo",
        "description": "Parking Reservation",
        "order_id": params.get("orderId"),
        "handler": function (response) {
    // 1. Update UI
    document.getElementById('status').innerText = "Payment Verified! Returning to App...";
    
    // 2. Build the URL
    const scheme = params.get("appScheme") || "parkngo://";
    const successUrl = `${scheme}payment-callback?razorpay_payment_id=${response.razorpay_payment_id}&razorpay_order_id=${response.razorpay_order_id}&razorpay_signature=${response.razorpay_signature}`;

    // 3. The "Double-Tap" Redirect
    // window.location.replace is better than .href as it doesn't save the "Initiating" page in history
    window.location.replace(successUrl);

    // 4. Critical: Show a manual button if the auto-redirect is blocked
    const fallbackBtn = document.getElementById('fallback-btn');
    fallbackBtn.href = successUrl;
    fallbackBtn.style.display = "block";
    fallbackBtn.innerText = "Click here to view your QR Pass";
},
        "modal": {
            "ondismiss": function() {
                window.location.href = appScheme + "payment-callback?status=cancelled";
            }
        },
        "theme": { "color": "#2F80ED" }
      };

      const rzp = new Razorpay(options);
      
      // Auto-open the payment modal on load
      window.onload = function() {
        rzp.open();
      };
    </script>
  </body>
</html>