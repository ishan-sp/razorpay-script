<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParkNGo Checkout</title>
    <style>
      body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
        display: flex; flex-direction: column; align-items: center; justify-content: center; 
        height: 100vh; margin: 0; background: #f8fafc; color: #0f172a; text-align: center; 
        padding: 20px;
      }
      .loader {
        border: 4px solid #f3f3f3; border-top: 4px solid #2f80ed;
        border-radius: 50%; width: 40px; height: 40px;
        animation: spin 1s linear infinite; margin-bottom: 20px;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      #status { font-size: 18px; font-weight: 600; margin-bottom: 10px; }
      .hint { color: #64748b; font-size: 14px; margin-bottom: 20px; }
      .btn { 
        display: none; padding: 16px 32px; background: #0f172a; color: white; 
        border-radius: 16px; text-decoration: none; font-weight: bold; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
    </style>
  </head>
  <body>
    <div class="loader" id="loader"></div>
    <div id="status">Initiating Secure Payment...</div>
    <div id="hint" class="hint">Please do not close this window or press back.</div>
    
    <a id="fallback-btn" class="btn">Return to App Manually</a>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
      const params = new URLSearchParams(window.location.search);
      const appScheme = params.get("appScheme") || "parkngo://";

      // 1. Success Handler: Build URL and attempt Jump
      function handleSuccess(response) {
    document.getElementById('loader').style.display = "none";
    document.getElementById('status').innerText = "Payment Verified!";
    
    // 1. Get the base scheme (e.g., "parkngo://")
    const baseScheme = params.get("appScheme") || "parkngo://";
    
    // 2. Point to the root "/" to avoid "Unmatched Route"
    // We add a '?' so the params are parsed correctly by Linking.parse
    const successUrl = `${baseScheme}?` + 
                       `razorpay_payment_id=${response.razorpay_payment_id}` + 
                       `&razorpay_order_id=${response.razorpay_order_id}` + 
                       `&razorpay_signature=${response.razorpay_signature}`;

    const btn = document.getElementById('fallback-btn');
    btn.href = successUrl;
    btn.style.display = "block";

    window.location.replace(successUrl);
    setTimeout(() => { window.location.href = successUrl; }, 800);
}

      window.onload = function() {
        // 2. LOOP PROTECTION: If the URL already contains success data, stop here.
        if (window.location.search.includes('razorpay_payment_id')) {
            document.getElementById('loader').style.display = "none";
            document.getElementById('status').innerText = "Payment already completed.";
            document.getElementById('fallback-btn').style.display = "block";
            return;
        }

        // 3. Setup Razorpay Options
        const options = {
          "key": params.get("keyId"),
          "amount": params.get("amount"),
          "currency": "INR",
          "name": "ParkNGo",
          "description": "Parking Reservation",
          "order_id": params.get("orderId"),
          "handler": handleSuccess,
          "modal": {
              "ondismiss": function() {
                  window.location.replace(appScheme + "payment-callback?status=cancelled");
              }
          },
          "theme": { "color": "#2F80ED" }
        };

        const rzp = new Razorpay(options);
        rzp.open();
      };
    </script>
  </body>
</html>